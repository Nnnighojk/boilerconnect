{% extends "dbtest/base.html" %}
{% load staticfiles %}
{% load guardian_tags %}
{% load widget_tweaks %}

{% block navbar %}
<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a  class="navbar-brand" rel="home" href="/" title="BoilerConnect">
            <img draggable="false" style="max-width:27px;margin-top:-3px;margin-right:-7px;"
                    src='{% static 'brand.png' %}'>
            </a>
            <a class="navbar-brand">Job Creation Process</a>
        </div>
    </div>
</div>
{% endblock navbar %}

{% block content %}
<div class="container">
    <div class="form-group">
        <form action="{% url 'job_creation' %}" method="post">{% csrf_token %}
            <ul class="nav nav-tabs">
                <li class="active"><a href="#tutorial" data-toggle="tab" aria-expanded="true">Explanation of the process</a></li>
                <li class=""><a href="#info" data-toggle="tab" aria-expanded="true">Basic information</a></li>
                <li class=""><a href="#specs" data-toggle="tab" aria-expanded="true">Job Specifications</a></li>
                <li class=""><a href="#orgs" data-toggle="tab" aria-expanded="true">Organizations selection</a></li>
            </ul>

            <div style="text-align:right;">
            <a id="prev_tab" style="display:none;" class="btn btn-primary" ">Previous</a>
            <a id="next_tab" class="btn btn-primary" ">Next</a>
            </div>

            <div id="myTabContent" class="tab-content">

                <!-- ############## Explanation Tab ############# -->

                <div class="tab-pane fade active in" id="tutorial">
                    <div class="row">
                        <div class="col-sm-4">
                        After your job is submitted, the copy of each submission is sent to all organizations that you selected. Those organizations will be able to review it, and they have an option to leave a comment on your job. If they do comment, you will be notified about this. 
                        </div>
                        <div class="col-sm-4">
                        After that, organizations will decide if they have capabilities to perform the job. Based on that, they will either accept the job or decline it, and you will be notified on this website, as well as in email about their decision.<br>
                        </div>
                        <div class="col-sm-4">
                        Finally, once you are satisfied with the responses from the organizations, you will be able to pick the organization that is going to do the job. We will exchange the contact information for you, and the rest of the communication is to be done on your behalf.
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4">
                        <img class="explanation" src="static/Part1.png"><br>
                        </div>
                        <div class="col-sm-4">
                        <img class="explanation" src="static/Part2.png"><br>
                        </div>
                        <div class="col-sm-4">
                        <img class="explanation" src="static/Part3.png"><br>
                        </div>
                    </div>
                </div>

                <!--########## Basic information Tab ##########-->

                <div class="tab-pane fade" id="info">
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-bullhorn"></i>
                        </span>
                        Name of the job.
                        {% render_field form.name class+="form-control" placeholder="Build a hotdog stand" %}
                    </div>
                </div>


                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-coffee"></i>
                        </span>
                        What organization or group are you representing?
                        {% render_field form.client_organization class+="form-control" placeholder="eg. Jimbobs Hotdog Joint" %}
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-coffee"></i>
                        </span>
                        Briefly describe the deliverables that you expect as a result of this project.
                        {% render_field form.deliverable class+="form-control" placeholder="A dozen savory, roasted weiners" %}
                    </div>
                </div>

                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-coffee"></i>
                        </span>
                        Give a short description of the job. Later, you will be able to provide more detailed description, keep this one brief.
                        {% render_field form.description class+="form-control" %}
                    </div>
                </div>

                <!------------ Technical specifications Tab ------------>

                <div class="tab-pane fade" id="specs">

                  <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-calendar"></i>
                        </span>
                        Specify the date when this project is due. If you are not sure of the exact date, give a close approximation.
                        {% render_field form.duedate class+="form-control" placeholder="yyyy-mm-dd" %}
                    </div>
                  </div>

                  <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-coffee"></i>
                        </span>
                        List stakeholders and anyone who might be affected by this work.  Give a description if necessary.
                        {% render_field form.stakeholders class+="form-control" placeholder="Jimbobs Hotdog Joint customers" %}
                    </div>
                  </div>

                  <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-cogs"></i>
                        </span>
                        If available, provide the technical specifications of the deliverable. In this section, you should be as precise as you can. 
                        {% render_field form.tech_specs class+="form-control" %}
                    </div>
                  </div>


                  <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-money"></i>
                        </span>
                        What is the budget that team can use for the project? You can provide the explanation along with the budget, or the estimation if you do not have precise data at the moment.
                      {% render_field form.budget class+="form-control" %}
                    </div>
                  </div>

                  <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-addon">
                        <i class="fa fa-file"></i>
                        </span>
                        If there are any files that you want to add in your job submission, do it here. 
                        {% render_field form.attachments %}
                    </div>
                  </div>

                </div>

                <!------------ Add Organizations Tab ---------------->
                <div style="display: none;">
                {{form.organization}}
                </div>

                <div class="tab-pane fade" id="orgs">
                    Filter the organizations to find the ones that you want to send the job request.
                    If an organization suits your needs, click <b> Add </b>.
                    You can add as many organizations as you want.
                    Once you are done, click <b> Submit Job </b>.
                    <div class="row org_search">
                        <div class="col-sm-6">
                        <h2>Search Organizations</h2>
                        <div class="form-group">
                        <label class="control-label" for="search">Filter Purdue Groups by name or tag</label>
                        <input id="search" class="form-control input-lg" type="text" >
                        </div>
                            <div class="org_list list-group" id="org_results">
                                {% for org in orgs %}
                                <div class="org_item list-group-item" org_pk="{{org.id}}">
                                    <h4 class="org_name list-group-item-heading">
                                    <a href="{% url 'organization_detail' org.id %}">
                                    {{org.name}}
                                    </a>
                                    <a class="org_button btn btn-success pull-right">Add</a>
                                    </h4>
                                    <p>
                                    {% for cat in org.categories.all %}
                                    <span class="category label label-default">{{ cat }}</span>
                                    {% endfor %}
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <h2>Selected Organizations</h2>
                            <div class="org_list list-group" id="org_selected">
                                {% for org in orgs %}
                                <div class="org_item list-group-item hidden" org_pk="{{org.id}}">
                                    <h4 class="org_name list-group-item-heading">
                                    <a href="{% url 'organization_detail' org.id %}">
                                    {{org.name}}
                                    </a>
                                    <a class="org_button btn btn-danger pull-right">Remove</a>
                                    </h4>
                                    <p>
                                    {% for cat in org.categories.all %}
                                    <span class="category label label-default">{{ cat }}</span>
                                    {% endfor %}
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                    <div class="row" style="text-align:right;">
                        <input type="submit" class="btn btn-primary" value="Submit Job" onclick="submitFunction()">
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>

<!------------------ tab navigation --------------------->

 function update_visibility(active_tab){
     console.log('active:',active_tab.attr('href'));
     if (active_tab.attr('href') == '#tutorial'){
         $('#prev_tab').hide();
         $('#next_tab').show();
     }
     else if (active_tab.attr('href') == '#orgs'){
         $('#next_tab').hide();
         $('#prev_tab').show();
     }
     else {
         $('#next_tab').show();
         $('#prev_tab').show();
     }
 }

 $('.nav-tabs').click(function(event){
     active_tab = $(event.target);
     console.log('hi2');
     update_visibility(active_tab);
 });

$('#next_tab').click(function(){
     active_tab = $('.nav-tabs > .active').next('li').find('a');
     active_tab.trigger('click');
     console.log('active_n:',active_tab.attr('href'));
     update_visibility(active_tab);
     }
);

$('#prev_tab').click(function(){
     active_tab = $('.nav-tabs > .active').prev('li').find('a');
     active_tab.trigger('click');
     console.log('active_p:',active_tab.attr('href'));
     update_visibility(active_tab);
     }
);

<!------------------ organization searching ---------------->
//select an org
$('#org_results').find('.org_item').find('.org_button').click(function(){
    var org_pk = $(this).closest('.org_item').attr("org_pk")
    $('#org_results').find('[org_pk="'+org_pk+'"]').addClass("hidden")
    $('#org_selected').find('[org_pk="'+org_pk+'"]').removeClass("hidden")
})

//deslect an org
$('#org_selected').find('.org_item').find('.org_button').click(function(){
    var org_pk = $(this).closest('.org_item').attr("org_pk")
    $('#org_results').find('[org_pk="'+org_pk+'"]').removeClass("hidden")
    $('#org_selected').find('[org_pk="'+org_pk+'"]').addClass("hidden")
})

//handle tag click action
$('#org_results').find('.category').click(function(){
    $('#search').val($(this).text())
    filter()
})

//handle already selected orgs on pageload
$(document).ready(function(){
  {% for org_pk in orgs_selected %}
    $('#org_results').find('[org_pk="'+{{org_pk}}+'"]').addClass("hidden")
    $('#org_selected').find('[org_pk="'+{{org_pk}}+'"]').removeClass("hidden")
  {% endfor %}

})

//filter org_results list by name and category
function filter(){
    console.log('keypress')
    var search_text = $('#search').val().toLowerCase();

    $('#org_results').find('.org_item').each(function(i,org_item){
        var show = 0;
        //check for match in each category, highlight match
        console.log($(org_item).find('.organization'))
        $(org_item).find('.category').each(function(i,cat_item){
            if (search_text && $(cat_item).text().search(search_text) >=0) {
                show = 1;
                $(cat_item).removeClass('label-default')
                $(cat_item).addClass('label-warning')
            }
            else {
                $(cat_item).removeClass('label-warning')
                $(cat_item).addClass('label-default')
            }
        })

        //check for match in name
        var name_str = $(org_item).children('.org_name').text().toLowerCase();
        if (name_str.search(search_text) >= 0){
            show = 1
        }

        //hide or show
        if (show) {
            $(org_item).show()
        }
        else {
            $(org_item).hide()
        }
    })
}

//filter for every keypress
$('#search').keyup(function() {
    filter()
});

<!------------------ submit button function ---------------->
function submitFunction() {
    $('#id_organization').val($("#org_selected").children(':not(.hidden)').map(function(){ return $(this).attr('org_pk') }))
}

</script>
{% endblock content %}
